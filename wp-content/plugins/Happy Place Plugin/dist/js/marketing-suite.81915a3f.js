!function(e){"use strict";let t={},n=!1,i="listing",o=[],a=[],r=null,s={};function l(){console.log("Marketing Suite: Attempting to load Fabric.js fallback...");const e=["https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js","https://unpkg.com/fabric@5.3.0/dist/fabric.min.js","https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"];let t=0;function n(){if(t>=e.length)return console.error("Marketing Suite: All Fabric.js CDN sources failed"),void D("Unable to load Fabric.js library. Please check your internet connection and refresh the page.");const i=document.createElement("script");i.src=e[t],i.onload=function(){console.log("Marketing Suite: Fabric.js loaded successfully from:",e[t]),setTimeout(f,100)},i.onerror=function(){console.warn("Marketing Suite: Failed to load from:",e[t]),t++,n()},document.head.appendChild(i)}let i=0;const o=setInterval(()=>{if(i++,"undefined"!=typeof fabric)return clearInterval(o),console.log("Marketing Suite: Fabric.js became available, continuing initialization"),void f();i>=30&&(clearInterval(o),n())},100)}const c={full_flyer:{width:850,height:1100,name:"Full Flyer",description:'8.5" x 11" print flyer',category:"print"},instagram_post:{width:1080,height:1080,name:"Instagram Post",description:"Square format for Instagram",category:"social"},instagram_story:{width:1080,height:1920,name:"Instagram Story",description:"Vertical story format",category:"social"},facebook_post:{width:1200,height:630,name:"Facebook Post",description:"Optimized for Facebook sharing",category:"social"},twitter_post:{width:1200,height:675,name:"Twitter Post",description:"Twitter card format",category:"social"},web_banner:{width:1200,height:400,name:"Web Banner",description:"Website hero banner",category:"web"},featured_listing:{width:600,height:400,name:"Featured Listing",description:"Website featured property",category:"web"},email_header:{width:800,height:300,name:"Email Header",description:"Email newsletter header",category:"email"},postcard:{width:600,height:400,name:"Postcard",description:'6" x 4" postcard format',category:"print"},business_card:{width:350,height:200,name:"Business Card",description:"Quick reference card",category:"print"}};function f(){if(console.log("Marketing Suite Generator: Initializing..."),"undefined"==typeof fabric)return console.warn("Marketing Suite: Fabric.js not immediately available, attempting to load..."),void l();let n=null;"undefined"!=typeof flyerGenerator?(n=flyerGenerator,console.log("Marketing Suite: Using flyerGenerator config")):"undefined"!=typeof marketingSuite?(n=marketingSuite,console.log("Marketing Suite: Using marketingSuite config")):"undefined"!=typeof marketingSuiteAjax&&(n=marketingSuiteAjax,console.log("Marketing Suite: Using marketingSuiteAjax config")),n||(console.error("Marketing Suite: No configuration object found"),n={ajaxUrl:window.ajaxurl||"/wp-admin/admin-ajax.php",nonce:"",dashboardNonce:""},console.warn("Marketing Suite: Using fallback configuration")),window.flyerGenerator=n,window.formatConfigs=c,function(){if(console.log("Marketing Suite: Initializing canvases..."),"undefined"==typeof fabric)return console.error("Marketing Suite: Fabric.js is not available for canvas initialization"),void D("Fabric.js library is not loaded. Please refresh the page.");Object.keys(c).forEach(e=>{const n=c[e];console.log(`Marketing Suite: Setting up canvas for ${e}:`,n);let i=document.getElementById(`canvas-${e}`);i||(console.log(`Marketing Suite: Creating canvas element for ${e}`),i=document.createElement("canvas"),i.id=`canvas-${e}`,i.width=n.width,i.height=n.height,i.style.display="none",document.body.appendChild(i));try{t[e]=new fabric.Canvas(`canvas-${e}`,{backgroundColor:"#ffffff",selection:!1,width:n.width,height:n.height}),console.log(`Marketing Suite: Canvas initialized successfully for ${e}:`,n.width,"x",n.height)}catch(t){console.error(`Marketing Suite: Error initializing canvas for ${e}:`,t),D(`Failed to initialize canvas for ${e}: ${t.message}`)}}),console.log("Marketing Suite: Canvas initialization complete. Total canvases:",Object.keys(t).length)}(),e('input[name="campaign_type"]').on("change",d),e('input[name="formats[]"]').on("change",u),window.selectFormats=function(t){const n=e('input[name="formats[]"]');n.prop("checked",!1),"social"===t?n.filter('[value="instagram_post"], [value="instagram_story"], [value="facebook_post"], [value="twitter_post"]').prop("checked",!0):"print"===t?n.filter('[value="full_flyer"], [value="postcard"], [value="business_card"]').prop("checked",!0):"web"===t?n.filter('[value="web_banner"], [value="featured_listing"], [value="email_header"]').prop("checked",!0):"all"===t&&n.prop("checked",!0),u()},e("#generate-marketing-suite").on("click",y),e("#download-all-zip").on("click",T),e("#download-individual").on("click",M),e("#listing-select").on("change",b),e("#open-house-date").on("change",g),e("#open-house-start, #open-house-end").on("change",p),e("#hosting-agent").on("change",p),e("#old-price, #new-price").on("input",w),e(".campaign-option").on("click",function(){e(".campaign-option").removeClass("active"),e(this).addClass("active"),e(this).find('input[type="radio"]').prop("checked",!0).trigger("change")}),e(".format-option").on("click",function(){const t=e(this).find('input[type="checkbox"]');t.prop("checked",!t.prop("checked")).trigger("change")}),e('input[name="template"]').on("change",function(){e(".template-option").removeClass("active"),e(this).closest(".template-option").addClass("active")}),e(".dismiss-error").on("click",C),function(){u(),b();const t=new Date,n=new Date;n.setDate(t.getDate()+(6-t.getDay())),e("#open-house-date").val(n.toISOString().split("T")[0]),g()}(),console.log("Marketing Suite Generator: Initialization complete")}function d(){const t=e('input[name="campaign_type"]:checked').val();i=t,console.log("Campaign type changed to:",t),e(".open-house-section").toggle("open_house"===t),e(".price-change-section").toggle("price_change"===t),R(),m()}function g(){const t=e("#open-house-date").val();if(t){const n=new Date(t),i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];e("#open-house-day").val(i[n.getDay()]),p()}}function p(){const t=e("#open-house-date").val(),n=e("#open-house-start").val(),i=e("#open-house-end").val(),o=e("#hosting-agent").val(),a=o?e("#hosting-agent option:selected").text():"Listing Agent";s={date:t,startTime:n,endTime:i,agentId:o,agentName:a},e(".oh-date span").text(t?new Date(t).toLocaleDateString():"Not set"),e(".oh-time span").text(n&&i?`${h(n)} - ${h(i)}`:"Not set"),e(".oh-agent span").text(a||"Not set"),m()}function h(e){if(!e)return"";const[t,n]=e.split(":"),i=parseInt(t);return`${i%12||12}:${n} ${i>=12?"PM":"AM"}`}function u(){o=[],e('input[name="formats[]"]:checked').each(function(){o.push(e(this).val())}),console.log("Selected formats:",o),m();const t=o.length;e(".format-count").text(t>0?`${t} format${1!==t?"s":""} selected`:"No formats selected")}function m(){const t=e("#listing-select").val(),n=o.length>0;let a=t&&n;"open_house"===i?a=a&&e("#open-house-date").val()&&e("#open-house-start").val()&&e("#open-house-end").val():"price_change"===i&&(a=a&&e("#old-price").val()&&e("#new-price").val()),e("#generate-marketing-suite").prop("disabled",!a)}function b(){const t=e("#listing-select").val();console.log("Listing changed to:",t),R(),m()}function w(){const t=parseFloat(e("#old-price").val())||0,n=parseFloat(e("#new-price").val())||0;if(t>0&&n>0){const i=t-n,o=(i/t*100).toFixed(1);e(".price-reduction").text(`$${i.toLocaleString()} (${o}%)`),e(".price-savings").text(`Save $${i.toLocaleString()}!`)}m()}function y(){if(console.log("Generate marketing suite button clicked"),n)return void console.log("Already generating, ignoring click");const l=e("#listing-select").val();l?0!==o.length?(console.log("Starting marketing suite generation for listing:",l),console.log("Selected formats:",o),console.log("Campaign type:",i),function(l){n=!0,x(!0),j(0,"Preparing generation..."),C();const f=Date.now(),d={action:"hph_generate_marketing_suite",nonce:flyerGenerator.nonce,listing_id:l,campaign_type:i,formats:o,open_house_data:"open_house"===i?s:null,price_change_data:"price_change"===i?{old_price:e("#old-price").val(),new_price:e("#new-price").val()}:null,template:e('input[name="template"]:checked').val()||"parker_group"};console.log("AJAX data:",d),j(10,"Fetching listing data..."),e.ajax({url:flyerGenerator.ajaxUrl,type:"POST",data:d,timeout:6e4,success:function(n){console.log("Marketing suite generation response:",n),function(n,s){if(console.log("Marketing suite generation response:",n),n.success&&n.data){const l=n.data;console.log("Received listing data:",l),r=l,j(30,"Creating marketing graphics..."),function(n,r){a=[];let s=0;const l=o.length;o.forEach((o,f)=>{setTimeout(()=>{j(30+60*f/l,`Creating ${c[o].name}...`),z(o,"processing");try{!function(e,n){const o=t[e],a=c[e];switch(console.log(`Creating ${e} graphic (${a.width}x${a.height})`),o.clear(),o.backgroundColor="#ffffff",e){case"full_flyer":!function(e,t,n){console.log("Creating full flyer matching PDF template");const i=k(t),o=new fabric.Rect({left:0,top:0,width:n.width,height:n.height,fill:"#ffffff",selectable:!1});e.add(o);const a=new fabric.Rect({left:0,top:0,width:n.width,height:730,fill:"#51bae0",selectable:!1});e.add(a);const r=new fabric.Text(v(),{left:n.width/2,top:50,fontSize:80,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",originX:"center",selectable:!1});e.add(r);const s=150,l=340,c=30,f=n.width-2*c;i.gallery&&i.gallery.length>0&&$(e,i.gallery[0],c,s,f,l);const d=s+l+15,g=110,p=(f-30)/3;if(i.gallery&&i.gallery.length>1)for(let t=0;t<Math.min(3,i.gallery.length-1);t++){const n=c+t*(p+15);$(e,i.gallery[t+1],n,d,p,g)}const h=d+g+15,u=60,m=new fabric.Rect({left:c,top:h,width:f,height:u,fill:"rgba(0,0,0,0.2)",selectable:!1});e.add(m);const b=i.bedrooms||"4",w=i.bathrooms||"3",y=i.square_feet||"1,800",_=new fabric.Text(`🛏 ${b} Bed    🚿 ${w} Bath    📐 ${y.toLocaleString()} Ft²`,{left:n.width/2,top:h+u/2,fontSize:24,fontFamily:"Poppins, sans-serif",fontWeight:"500",fill:"#ffffff",originX:"center",originY:"center",selectable:!1});e.add(_);const F=S(i.price||"805000"),x=new fabric.Text(F,{left:n.width-c-20,top:h+u/2,fontSize:48,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",originX:"right",originY:"center",selectable:!1});e.add(x);const P=760,j=i.street_address||"120 McFee St.",z=`${i.city||"Lewes"}, ${i.state||"DE"} ${i.zip_code||"19958"}`,T=new fabric.Text(j,{left:60,top:P,fontSize:36,fontFamily:"Poppins, sans-serif",fontWeight:"600",fill:"#51bae0",selectable:!1});e.add(T);const M=new fabric.Text(z,{left:60,top:P+40,fontSize:22,fontFamily:"Poppins, sans-serif",fontWeight:"400",fill:"#333333",selectable:!1});e.add(M);const R=i.description||"lkahsdlakjsd askdjlaskdj sldkjals kdlskjd alksdj sdal skdjlskdj\nsldkjalskd lskdj sdlaksjda sdlksjdl ksdalskjdla skdjalskdj\nasdjijalskdj",D=new fabric.Textbox(R,{left:60,top:P+80,width:n.width-120,fontSize:14,fontFamily:"Arial, sans-serif",fontWeight:"400",fill:"#666666",lineHeight:1.4,selectable:!1});e.add(D);const C=960,A=80,E=new fabric.Circle({left:60,top:C,radius:A/2,fill:"#e0e0e0",selectable:!1});e.add(E);const W=t.agent?.display_name||"Pat Gallagher",L="REALTOR®",N=new fabric.Text(W,{left:160,top:C+5,fontSize:24,fontFamily:"Poppins, sans-serif",fontWeight:"600",fill:"#51bae0",selectable:!1});e.add(N);const U=new fabric.Text(L,{left:160,top:C+35,fontSize:14,fontFamily:"Poppins, sans-serif",fontWeight:"400",fill:"#666666",selectable:!1});e.add(U);const G=t.agent?.email||"patrick@theparkergroup.com",O=t.agent?.phone||"3026821702",I=new fabric.Text(`📧 ${G}\n📱 ${function(e){const t=e.replace(/\D/g,"");return 10===t.length?`${t.slice(0,3)}.${t.slice(3,6)}.${t.slice(6)}`:e}(O)}`,{left:160,top:C+55,fontSize:12,fontFamily:"Poppins, sans-serif",fontWeight:"400",fill:"#666666",lineHeight:1.4,selectable:!1});e.add(I),function(e,t,n){const i=new fabric.Group([new fabric.Rect({left:0,top:0,width:40,height:35,fill:"#51bae0"}),new fabric.Triangle({left:0,top:-15,width:40,height:20,fill:"#51bae0"})],{left:t,top:n,selectable:!1});e.add(i);const o=new fabric.Text("the parker group",{left:t+50,top:n,fontSize:20,fontFamily:"Poppins, sans-serif",fontWeight:"600",fill:"#333333",selectable:!1});e.add(o);const a=new fabric.Text("find your happy place",{left:t+50,top:n+25,fontSize:14,fontFamily:"Poppins, sans-serif",fontWeight:"400",fontStyle:"italic",fill:"#51bae0",selectable:!1});e.add(a)}(e,n.width-250,P),function(e,t,n,i){const o=new fabric.Rect({left:t,top:n,width:i,height:i,fill:"#f0f0f0",stroke:"#333333",strokeWidth:2,selectable:!1});e.add(o);for(let i=0;i<5;i++)for(let o=0;o<5;o++)if(Math.random()>.5){const a=new fabric.Rect({left:t+10+20*i,top:n+10+20*o,width:15,height:15,fill:"#333333",selectable:!1});e.add(a)}const a=new fabric.Text("Get in touch",{left:t+i/2,top:n-20,fontSize:12,fontFamily:"Poppins, sans-serif",fontWeight:"500",fill:"#666666",originX:"center",selectable:!1});e.add(a);const r=new fabric.Text("📧  📱  📍",{left:t+i/2,top:n+i+10,fontSize:16,originX:"center",selectable:!1});e.add(r)}(e,n.width-160,C,120);const X="673 N Bedford St, Georgetown, DE",B=new fabric.Text(X,{left:n.width-250,top:C+100,fontSize:11,fontFamily:"Poppins, sans-serif",fontWeight:"400",fill:"#666666",selectable:!1});e.add(B)}(o,n,a);break;case"instagram_post":!function(e,t,n){const o=n.width,a=new fabric.Rect({left:0,top:0,width:o,height:o,fill:"#51bae0",selectable:!1});e.add(a),t.gallery&&t.gallery.length>0&&$(e,t.gallery[0],60,60,o-120,.6*(o-120));const r=S(t.price||t.listing?.price),s=new fabric.Text(r,{left:80,top:o-300,fontSize:72,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",selectable:!1,shadow:new fabric.Shadow({color:"rgba(0,0,0,0.5)",blur:10,offsetX:2,offsetY:2})});e.add(s);const l=_(t),c=new fabric.Text(l,{left:80,top:o-220,fontSize:36,fontFamily:"Poppins, sans-serif",fontWeight:"500",fill:"#ffffff",selectable:!1,shadow:new fabric.Shadow({color:"rgba(0,0,0,0.5)",blur:8,offsetX:2,offsetY:2})});e.add(c),function(e,t,n,i,o){const a=new fabric.Rect({left:t,top:n,width:i,height:o,fill:"rgba(255,255,255,0.9)",rx:8,ry:8,selectable:!1});e.add(a);const r=new fabric.Text("PARKER GROUP",{left:t+i/2,top:n+o/2,fontSize:14,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#51bae0",originX:"center",originY:"center",selectable:!1});e.add(r)}(e,o-200,60,140,60),"open_house"===i&&F(e,o/2,o-150,36)}(o,n,a);break;case"instagram_story":!function(e,t,n){const o=n.width,a=n.height,r=new fabric.Rect({left:0,top:0,width:o,height:a,fill:new fabric.Gradient({type:"linear",coords:{x1:0,y1:0,x2:0,y2:a},colorStops:[{offset:0,color:"#51bae0"},{offset:1,color:"#3a9bc1"}]}),selectable:!1});e.add(r),t.gallery&&t.gallery.length>0&&$(e,t.gallery[0],40,.25*a,o-80,.4*a);const s=o/2,l=v(),c=new fabric.Text(l,{left:s,top:100,fontSize:48,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",originX:"center",selectable:!1});e.add(c);const f=S(t.price||t.listing?.price),d=new fabric.Text(f,{left:s,top:.7*a,fontSize:64,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",originX:"center",selectable:!1});e.add(d);const g=_(t),p=new fabric.Text(g,{left:s,top:.78*a,fontSize:32,fontFamily:"Poppins, sans-serif",fontWeight:"500",fill:"#ffffff",originX:"center",selectable:!1});e.add(p),"open_house"===i&&F(e,s,.85*a,28)}(o,n,a);break;case"facebook_post":case"twitter_post":!function(e,t,n){const i=n.width,o=n.height,a=new fabric.Rect({left:0,top:0,width:i,height:o,fill:"#51bae0",selectable:!1});e.add(a);const r=.6*i,s=.35*i,l=.65*i;t.gallery&&t.gallery.length>0&&$(e,t.gallery[0],0,0,r,o);const c=o/2,f=v(),d=new fabric.Text(f,{left:l,top:c-120,fontSize:32,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",selectable:!1});e.add(d);const g=S(t.price||t.listing?.price),p=new fabric.Text(g,{left:l,top:c-60,fontSize:42,fontFamily:"Poppins, sans-serif",fontWeight:"bold",fill:"#ffffff",selectable:!1});e.add(p);const h=_(t),u=new fabric.Textbox(h,{left:l,top:c+10,width:s-40,fontSize:18,fontFamily:"Poppins, sans-serif",fontWeight:"500",fill:"#ffffff",selectable:!1});e.add(u),function(e,t,n,i,o){const a=k(t),r=a.bedrooms||"4",s=a.bathrooms||"3",l=a.square_feet||"1,800";let c="";if("N/A"!==r&&(c+=`${r} Bed`),"N/A"!==s&&(c+=(c?" • ":"")+`${s} Bath`),"N/A"!==l&&(c+=(c?" • ":"")+`${l.toLocaleString()} Ft²`),c){const t=new fabric.Text(c,{left:n,top:i,fontSize:o,fontFamily:"Poppins, sans-serif",fontWeight:"500",fill:"#ffffff",selectable:!1});e.add(t)}}(e,t,l,c+80,16)}(o,n,a);break;case"web_banner":createWebBanner(o,n,a);break;case"featured_listing":createFeaturedListing(o,n,a);break;case"email_header":createEmailHeader(o,n,a);break;case"postcard":createPostcard(o,n,a);break;case"business_card":createBusinessCard(o,n,a);break;default:console.warn(`No creation function for format: ${e}`),createGenericFormat(o,n,a)}o.renderAll()}(o,n),setTimeout(()=>{s++,z(o,"completed");const n=t[o],i=n.toDataURL("image/png"),f=Math.round(3*i.length/4);if(a.push({format:o,name:c[o].name,canvas:n,dataURL:i,fileSize:f}),console.log(`Generated ${o}:`,c[o].name),s===l){const t=Date.now()-r,n=a.reduce((e,t)=>e+t.fileSize,0);j(100,"Marketing suite complete!"),setTimeout(()=>{!function(t,n,i){const o=t.length,a=t.filter(e=>e.dataURL).length,r=Math.round(n/1024/o),s=Math.round(i/1e3);e(".stat-number").each(function(t){const n=[o,a,r+"KB",s+"s"];e(this).text(n[t]||"0")});const l=e(".preview-grid");l.empty(),t.forEach(t=>{const n=function(t){const n=c[t.format],i=t.canvas,o=i.toDataURL("image/jpeg",.3);return e(`\n            <div class="preview-item">\n                <div class="preview-image" style="background-image: url('${o}')"></div>\n                <div class="preview-title">${t.name}</div>\n                <div class="preview-dimensions">${n.width} × ${n.height}</div>\n                <div class="preview-actions">\n                    <button class="btn btn-mini btn-outline" onclick="previewFormat('${t.format}')">Preview</button>\n                    <button class="btn btn-mini btn-primary" onclick="downloadFormat('${t.format}')">Download</button>\n                </div>\n            </div>\n        `)}(t);l.append(n)}),e(".generation-results").show(),setTimeout(()=>{e("html, body").animate({scrollTop:e(".generation-results").offset().top-100},500)},500)}(a,n,t),P()},1e3)}},500+200*f)}catch(e){console.error(`Error creating ${o}:`,e),z(o,"error"),s++,s===l&&(P(),D("Some formats failed to generate. Check console for details."))}},300*f)})}(l,s)}else{const e=n.data?.message||n.data||"Unknown error occurred";console.error("Generation Error:",n),D("Error: "+e),P()}}(n,f)},error:function(e,t,n){console.error("AJAX Request Failed:",{xhr:e,status:t,error:n}),function(e,t,n){console.error("AJAX Request Failed:",{xhr:e,status:t,error:n}),P();let i="Error generating marketing suite. Please try again.";403===e.status?i="Permission denied. Please refresh and try again.":404===e.status?i="Service not found. Please contact support.":500===e.status?i="Server error. Please try again later.":"timeout"===t?i="Request timed out. Please try with fewer formats.":e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message&&(i=e.responseJSON.data.message),D(i)}(e,t,n)},complete:function(){n=!1}})}(l)):D("Please select at least one format."):D("Please select a listing.")}function k(e){const t={price:e.price||e.listing?.price||805e3,address:e.address||e.listing?.address||"120 McFee St.",street_address:e.street_address||e.address||e.listing?.address||"120 McFee St.",city:e.city||e.listing?.city||"Lewes",state:e.state||e.listing?.state||"DE",zip_code:e.zip_code||e.zip||e.listing?.zip||"19958",bedrooms:e.bedrooms||e.beds||e.listing?.bedrooms||4,bathrooms:e.bathrooms||e.baths||e.listing?.bathrooms||3,square_feet:e.square_feet||e.sqft||e.listing?.square_feet||1800,lot_size:e.lot_size||e.listing?.lot_size||"",description:e.description||e.listing?.description||"",gallery:[]};return e.gallery&&Array.isArray(e.gallery)?t.gallery=e.gallery.map(e=>"object"==typeof e&&e.url?e.url:"string"==typeof e?e:null).filter(e=>null!==e):e.listing?.gallery?t.gallery=Array.isArray(e.listing.gallery)?e.listing.gallery:[e.listing.gallery]:e.main_photo&&(t.gallery=[e.main_photo]),t}function v(){switch(i){case"listing":default:return"FOR SALE";case"open_house":return"OPEN HOUSE";case"price_change":return"PRICE REDUCED";case"under_contract":return"UNDER CONTRACT";case"sold":return"SOLD"}}function S(e){return e&&0!==e?"$"+("string"==typeof e?parseFloat(e.replace(/[^0-9.]/g,"")):e).toLocaleString():"$805,000"}function _(e){const t=k(e);return t.street_address&&t.city?`${t.street_address}, ${t.city}`:t.street_address?t.street_address:t.address?t.address:"120 McFee St., Lewes"}function $(e,t,n,i,o,a){if(!t){const t=new fabric.Rect({left:n,top:i,width:o,height:a,fill:"#e0e0e0",selectable:!1});return void e.add(t)}fabric.Image.fromURL(t,function(t){const r=o/t.width,s=a/t.height,l=Math.max(r,s),c=t.width*l,f=t.height*l,d=n+(o-c)/2,g=i+(a-f)/2;t.set({left:d,top:g,scaleX:l,scaleY:l,selectable:!1,crossOrigin:"anonymous"});const p=new fabric.Rect({left:n,top:i,width:o,height:a,absolutePositioned:!0});t.clipPath=p,e.add(t),e.renderAll()},{crossOrigin:"anonymous"})}function F(e,t,n,o){if("open_house"!==i||!s.date)return;const a=new Date(s.date).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),r=`${h(s.startTime)} - ${h(s.endTime)}`,l=new fabric.Text(`${a}\n${r}`,{left:t,top:n,fontSize:o,fontFamily:"Poppins, sans-serif",fontWeight:"600",fill:"#ffffff",originX:"center",textAlign:"center",selectable:!1,shadow:new fabric.Shadow({color:"rgba(0,0,0,0.5)",blur:5,offsetX:1,offsetY:1})});e.add(l)}function x(t){t?(e(".generation-progress").show(),e("#generate-marketing-suite").prop("disabled",!0),e(".generation-results").hide()):(e(".generation-progress").hide(),e("#generate-marketing-suite").prop("disabled",!1))}function P(){x(!1)}function j(t,n){e(".progress-fill").css("width",t+"%"),e(".progress-text").text(n),z()}function z(t=null,n=null){if(!t)return;const i=e(".format-progress");let o=i.find(`[data-format="${t}"]`);0===o.length&&(o=e(`<div class="format-progress-item" data-format="${t}">${c[t].name}</div>`),i.append(o)),n&&o.removeClass("processing completed error").addClass(n)}function T(){if("undefined"==typeof JSZip)return void D("JSZip library not loaded. Cannot create ZIP file.");if(0===a.length)return void D("No results to download.");const e=new JSZip,t=[];a.forEach(n=>{const o=n.canvas,a=new Promise(t=>{o.toBlob(o=>{e.file(`${i}-${n.format}.png`,o),t()},"image/png")});t.push(a)}),Promise.all(t).then(()=>{e.generateAsync({type:"blob"}).then(e=>{const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`marketing-suite-${i}-${Date.now()}.zip`,t.click()})}).catch(e=>{console.error("ZIP generation failed:",e),D("Failed to create ZIP file.")})}function M(){e(".preview-grid").toggle()}function R(){e(".generation-results").hide(),e(".preview-grid").empty(),a=[]}function D(t){console.error("Marketing Suite Generator Error:",t);const n=e(".flyer-error");if(n.length)n.find(".error-message").text(t),n.show();else{const n=`\n                <div class="flyer-error">\n                    <div class="error-content">\n                        <i class="fas fa-exclamation-triangle"></i>\n                        <span class="error-message">${t}</span>\n                        <button type="button" class="dismiss-error">&times;</button>\n                    </div>\n                </div>\n            `;e("body").append(n),e(".dismiss-error").on("click",C)}setTimeout(C,5e3)}function C(){e(".flyer-error").fadeOut()}e(document).ready(function(){console.log("Marketing Suite Generator: Document ready"),f()}),window.downloadFormat=function(e){const t=a.find(t=>t.format===e);if(!t)return;c[e];const n=t.canvas.toDataURL("image/png"),o=document.createElement("a");o.download=`${i}-${e}-${Date.now()}.png`,o.href=n,o.click()},window.previewFormat=function(e){const t=a.find(t=>t.format===e);if(!t)return;const n=t.canvas.toDataURL("image/png");window.open("","_blank").document.write(`\n            <html>\n                <head><title>${t.name} Preview</title></head>\n                <body style="margin:0;padding:20px;text-align:center;background:#f0f0f0;">\n                    <h2>${t.name}</h2>\n                    <img src="${n}" style="max-width:100%;height:auto;border:1px solid #ccc;">\n                </body>\n            </html>\n        `)},window.downloadPNG=function(){a.length>0&&a.find(e=>"full_flyer"===e.format)&&downloadFormat("full_flyer")},window.downloadPDF=function(){D("PDF download feature coming soon.")},window.initializeMarketingSuite=f}(jQuery);